---
- name: Backup databases and copy to SMB
  hosts: localhost
  gather_facts: no
  become: true  # Isso concede privilégios de superusuário para as tarefas
  tasks:
    # Verifica se o script de backup existe
    - name: Check if backup script exists
      ansible.builtin.stat:
        path: "{{ backup_script_path }}"
      register: script_stat

    - name: Fail if backup script does not exist
      ansible.builtin.fail:
        msg: "O script de backup não foi encontrado em {{ backup_script_path }}."
      when: not script_stat.stat.exists

    # Executa o script de backup
    - name: Run the backup script
      ansible.builtin.command:
        _raw_params: "python3 {{ backup_script_path }}"
      register: backup_result
      changed_when: false  # Não marca a tarefa como "changed" (apenas execução)

    - name: Debug backup result
      ansible.builtin.debug:
        msg: "{{ backup_result.stdout }}"

    # Encontra a pasta de backup gerada
    - name: Find the backup folder
      ansible.builtin.find:
        paths: /home/bkp/db
        patterns: "BKP_DB_*"
        file_type: directory
      register: backup_folder

    - name: Debug backup folder
      ansible.builtin.debug:
        msg: "{{ backup_folder.files | map(attribute='path') | list }}"

    # Monta o compartilhamento SMB
    - name: Create mount point directory
      ansible.builtin.file:
        path: /mnt/smb/db
        state: directory
        mode: '0755'

    - name: Mount the SMB share
      ansible.builtin.mount:
        path: /mnt/smb/db
        src: "//{{ smb_server }}/{{ smb_share }}"
        fstype: cifs
        opts: "username={{ smb_username }},password={{ smb_password }},domain={{ smb_domain }}"
        state: mounted

    # Copia a pasta de backup para o SMB
    - name: Copy backup folder to SMB
      ansible.builtin.copy:
        src: "{{ item.path }}"
        dest: "/mnt/smb/db/{{ item.path.split('/')[-1] }}"
        remote_src: yes  # Indica que o arquivo está no host local
      loop: "{{ backup_folder.files }}"
      when: backup_folder.matched > 0

    # Desmonta o compartilhamento SMB
    - name: Unmount the SMB share
      ansible.builtin.mount:
        path: /mnt/smb/db
        state: unmounted

    # Limpa o ponto de montagem
    - name: Remove mount point directory
      ansible.builtin.file:
        path: /mnt/smb/db
        state: absent
